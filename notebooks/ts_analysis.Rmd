---
title: "Time series analysis"
author: "Nick Hagar"
date: "1/28/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
source('../scripts/functions_ts.R')
source('../scripts/functions_metadata.R')
source('../scripts/functions_text.R')
```


## Loading and aggregating data
```{r loaddata}
df <- load_data()

df_agg <- agg_df(df, '2019-01-05', '2019-02-07')

ts_weekly <- convert_ts(df_meta_agg)
```

## Aggregate time series analysis
```{r decomposition}
decomp_plots(ts_weekly)
```

```{r modeling}
model <- lm_df(df_meta_agg, '2019-01-25')
summary(model)
```

```{r detrend}
detrend_ts(ts_weekly)
```

## Regression discontinuity analysis
```{r}
library(rdrobust)
library(rdd)

df_agg <- df_agg %>% 
  ungroup() %>% 
  mutate(relative_days=as.integer(pub_date-as_date("2019-01-25"))) %>% 
  filter(relative_days>=-12)

rdrobust(df_agg$stories, df_agg$relative_days, covs = df_agg$day_of_week)

est <- RDestimate(stories ~ relative_days, data=df_agg, cutpoint = 0)

est_cov <- RDestimate(stories ~ relative_days | day_of_week, data=df_agg, cutpoint = 0)

plot(est)

plot(est_cov)

df_agg %>% 
  RDestimate(stories ~ relative_days)

df_agg
```

