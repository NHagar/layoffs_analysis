---
title: "Time series analysis"
author: "Nick Hagar"
date: "1/28/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
source('../scripts/functions_ts.R')
source('../scripts/functions_metadata.R')
source('../scripts/functions_text.R')
```


## Loading and text processing data
```{r loaddata}
df <- load_data()

df <- df %>% 
  #Count social embeds
  text_embeds(.) %>% 
  #Remove social embeds
  mutate(text_body=text_clean(text_body)) %>% 
  #Calculate length
  text_lengths(.) %>% 
  #Tag with sentiment
  text_sent(.)

#TODO: Tag NLP
df

#Transform measures
df <- df %>% 
  select(-text_body, -hed, -subhed) %>% 
  mutate(neg_pct=negative/len_words,
         pos_pct=positive/len_words,
         polarity=pos_pct-neg_pct,
         log_len_chars=log1p(len_chars),
         log_len_words=log1p(len_words),
         has_tweet=tweets>0,
         has_insta=insta>0)

#Aggregate all measures to the daily level
df_agg <- df %>% 
  group_by(pub_date) %>% 
  summarize(stories=n(), bylines=n_distinct(byline),
            log_len_chars=mean(log_len_chars), log_len_words=mean(log_len_words),
            polarity=mean(polarity),
            pct_tweet=sum(has_tweet)/n(),
            pct_insta=sum(has_insta)/n()) %>% 
  mutate(day_of_week=wday(pub_date))

df_agg <- df_agg %>% 
  filter(pub_date>=as_datetime("2019-01-05") & pub_date<=("2019-02-07"))

byline_ts <- df_agg %>% 
  convert_ts(., "log_len_chars")
```


## Aggregate time series analysis
```{r decomposition}
decomp_plots(byline_ts)
```

```{r}
decomposed <- decompose(byline_ts)

deseasoned <- decomposed$x - decomposed$seasonal
plot(deseasoned)

df_agg$deseasoned <- deseasoned
```


```{r modeling}
model <- lm_df(df_meta_agg, '2019-01-25')
summary(model)
```

```{r detrend}
detrend_ts(ts_weekly)
```

## Regression discontinuity analysis
```{r}
library(rdrobust)
rdrobust(df_agg$stories, df_agg$relative_days, covs = df_agg$day_of_week)
library(rdd)

df_agg <- df_agg %>% 
  ungroup() %>% 
  mutate(relative_days=as.integer(pub_date-as_date("2019-01-25"))) %>% 
  filter(relative_days>=-12)

est <- RDestimate(deseasoned ~ relative_days, data=df_agg, cutpoint = 0)
summary(est)
```

